#define _GNU_SOURCE     /* for RTLD_NEXT */
#include <string.h>
#include <unistd.h>
#include <dlfcn.h>
#include <err.h>
#include<stdio.h>
#include<stdlib.h>
#ifdef __UCLIBC__
#define __libc_start_main       __uClibc_main
#endif
#define STR_(s) #s
#define STR(s)  STR_(s)
int __libc_start_main(
        int (*main)(int,char**,char**), int ac, char **av,
        int (*init)(int,char**,char**), void (*fini)(void),
        void (*rtld_fini)(void), void *stack_end)
{
        //printf("in custom libray\n");
        //printf("%s\n",av[0]);
        //char *tester="/home/ubuntu20/Desktop/data/test";
        char *tester="/data/arpank/malwareproject/predict.py";
        //printf("\n%s\n",tester);
        //printf("%d",strcmp(tester,ubp_av[0]));
        char *cmd=(char*)malloc(strlen(tester)+strlen(av[0])+1);
        strcat(cmd,tester);
        strcat(cmd," ");
        strcat(cmd,av[0]);
        //cmd=strcat(cmd,ubp_av[0]);
        //printf("%s",cmd);
	//printf("av[0]=%s\n", av[0]);
        int n=0;
        //if(strcmp(tester,av[0])&&strcmp(av[0],"sh"))
        //if(strcmp(tester,av[0]) != 0 && strcmp(av[0],"sh") != 0 && strcmp(av[0], "/bin/sh") != 0)
        if(strcmp(tester,av[0]) != 0 && strcmp(av[0],"sh") != 0 && strcmp(av[0], "/bin/sh") != 0
		&& strcmp(av[0], "from") != 0
		&& strcmp(av[0], "/usr/bin/env") != 0
		&& strcmp(av[0], "python3") != 0
		&& strcmp(av[0], "/usr/bin/python3") != 0)
        {
            //printf("\n Need to run analysis\n");
	    //printf("executing %s\n", cmd);
            n=system(cmd);
        }
        if(n==0)
        {
        typeof(__libc_start_main) *real_lsm;
        if(*(void**)&real_lsm = dlsym(RTLD_NEXT, STR(__libc_start_main)))
                return real_lsm(main, ac , av , init, fini, rtld_fini, stack_end);
        else
                errx(1, "BUG: dlsym: %s", dlerror());
        }
        else
        {
            errx(1,"MALWARE ALERT");
        }
}
/*
$ cc -fPIC -shared -Wall -W -Wno-parentheses skip.c -o skip1.so -ldl
$ cc -fPIC -shared -Wall -W -Wno-parentheses skip.c -o skip2.so -ldl
$ LD_PRELOAD="./skip1.so ./skip2.so" /bin/echo a b c d
c d */
